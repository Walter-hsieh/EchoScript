<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialogue to Audio Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #FAFBFC;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563EB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        audio::-webkit-media-controls-panel {
            background-color: #F8FAFC;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-mute-button {
            color: #64748B;
        }
        /* Custom select styling */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        /* Professional button styles */
        .btn-primary {
            background-color: #2563EB;
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #1D4ED8;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #F8FAFC;
            color: #475569;
            border: 1px solid #E2E8F0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #F1F5F9;
            border-color: #CBD5E1;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        /* Card styling */
        .card {
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #E2E8F0;
        }
        /* Form input styling */
        .form-input {
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-3xl card p-8 md:p-10 space-y-8">
        <!-- Header -->
        <div class="text-center bg-gray-50 rounded-lg p-6 border border-gray-100">
            <h1 class="text-4xl font-bold text-gray-900 mb-3">EchoScript</h1>
            <p class="text-gray-600 text-sm">Transform written dialogues into lifelike, multi-speaker audio conversations</p>
        </div>
            <!-- Mobile sticky action bar -->
    <div class="fixed bottom-0 left-0 right-0 md:hidden bg-white/95 backdrop-blur border-t border-gray-200 p-4">
        <button id="generateBtnMobile" class="w-full btn-primary font-bold py-3 px-6 rounded-lg">Convert to Audio</button>
    </div>
                    <div id="parseStatus" class="text-sm text-gray-500 mt-3 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Lines: 0 • Speakers detected: –
            </div>

        <!-- API Key Bar -->
        <div id="apiKeyBar" class="rounded-lg border border-blue-200 bg-blue-50 p-4 flex items-center gap-3">
            <label for="apiKeyInput" class="text-sm font-medium text-gray-700">Gemini API Key</label>
            <input id="apiKeyInput" type="password" placeholder="Paste your API key here..." class="flex-1 form-input p-3 text-sm">
            <button id="saveApiKeyBtn" class="btn-primary text-sm font-medium py-2 px-4 rounded-md">Save</button>
            <button id="toggleApiKeyVisibility" class="text-sm text-blue-600 hover:text-blue-700 font-medium">Show</button>
        </div>

        <!-- Voice Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="voiceSpeaker1" class="block text-sm font-semibold text-gray-900 mb-3">Voice for Speaker 1</label>
                <div class="flex gap-3">
                    <select id="voiceSpeaker1" class="w-full custom-select form-input p-3 text-sm">
                        <option value="kore" selected>Kore</option>
                        <option value="callirrhoe">Callirrhoe</option>
                        <option value="achernar">Achernar</option>
                        <option value="achird">Achird</option>
                        <option value="algenib">Algenib</option>
                        <option value="algieba">Algieba</option>
                        <option value="alnilam">Alnilam</option>
                        <option value="aoede">Aoede</option>
                        <option value="autonoe">Autonoe</option>
                        <option value="charon">Charon</option>
                        <option value="despina">Despina</option>
                        <option value="enceladus">Enceladus</option>
                        <option value="erinome">Erinome</option>
                        <option value="fenrir">Fenrir</option>
                        <option value="gacrux">Gacrux</option>
                        <option value="iapetus">Iapetus</option>
                        <option value="laomedeia">Laomedeia</option>
                        <option value="leda">Leda</option>
                        <option value="orus">Orus</option>
                        <option value="puck">Puck</option>
                        <option value="pulcherrima">Pulcherrima</option>
                        <option value="rasalgethi">Rasalgethi</option>
                        <option value="sadachbia">Sadachbia</option>
                        <option value="sadaltager">Sadaltager</option>
                        <option value="schedar">Schedar</option>
                        <option value="sulafat">Sulafat</option>
                        <option value="umbriel">Umbriel</option>
                        <option value="vindemiatrix">Vindemiatrix</option>
                        <option value="zephyr">Zephyr</option>
                        <option value="zubenelgenubi">Zubenelgenubi</option>
                    </select>
                    <button id="preview1" class="btn-secondary shrink-0 text-sm font-medium px-4 py-3 rounded-md">Preview</button>
                </div>
            </div>
            <div>
                <label for="voiceSpeaker2" class="block text-sm font-semibold text-gray-900 mb-3">Voice for Speaker 2</label>
                <div class="flex gap-3">
                    <select id="voiceSpeaker2" class="w-full custom-select form-input p-3 text-sm">
                        <option value="callirrhoe" selected>Callirrhoe</option>
                        <option value="kore">Kore</option>
                        <option value="achernar">Achernar</option>
                        <option value="achird">Achird</option>
                        <option value="algenib">Algenib</option>
                        <option value="algieba">Algieba</option>
                        <option value="alnilam">Alnilam</option>
                        <option value="aoede">Aoede</option>
                        <option value="autonoe">Autonoe</option>
                        <option value="charon">Charon</option>
                        <option value="despina">Despina</option>
                        <option value="enceladus">Enceladus</option>
                        <option value="erinome">Erinome</option>
                        <option value="fenrir">Fenrir</option>
                        <option value="gacrux">Gacrux</option>
                        <option value="iapetus">Iapetus</option>
                        <option value="laomedeia">Laomedeia</option>
                        <option value="leda">Leda</option>
                        <option value="orus">Orus</option>
                        <option value="puck">Puck</option>
                        <option value="pulcherrima">Pulcherrima</option>
                        <option value="rasalgethi">Rasalgethi</option>
                        <option value="sadachbia">Sadachbia</option>
                        <option value="sadaltager">Sadaltager</option>
                        <option value="schedar">Schedar</option>
                        <option value="sulafat">Sulafat</option>
                        <option value="umbriel">Umbriel</option>
                        <option value="vindemiatrix">Vindemiatrix</option>
                        <option value="zephyr">Zephyr</option>
                        <option value="zubenelgenubi">Zubenelgenubi</option>
                    </select>
                    <button id="preview2" class="btn-secondary shrink-0 text-sm font-medium px-4 py-3 rounded-md">Preview</button>
                </div>
            </div>
        </div>

        <!-- Upload .txt Button -->
        <div class="flex items-center gap-4">
            <input id="fileInput" type="file" accept=".txt" class="hidden">
            <button id="uploadBtn" class="btn-secondary font-medium py-3 px-6 rounded-md">
                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                Upload Script
            </button>
        </div>

        <!-- Dialogue Input -->
        <div>
            <label for="dialogue" class="block text-sm font-semibold text-gray-900 mb-3">Dialogue Script</label>
            <textarea id="dialogue" rows="15" class="w-full form-input p-4 text-sm leading-relaxed">Me: Hey! Finally calling. How was your day? How was the trip with your little graduate?
Wife: It was so much fun! He was so excited. You know how they get at that age. My day was great. How was yours? Sounded like you had a full schedule.
Me: You have no idea. Man, what a day. It seriously felt like three different days packed into one.
Wife: Oh no, that sounds exhausting. Was it a good day or a bad day?
Me: A good day, I think. Definitely a rewarding one. The afternoon started out great, actually. I had lunch with the interns from Malaysia, and it was just a really good time, you know? Just connecting with them.
Wife: That’s nice! They seem like a good group.
Me: They are. But then, on the walk back to my car, the sky just opened up. A total downpour. We had to make a run for it and ended up ducking into this little dessert shop.
Wife: Wait, that actually sounds kind of perfect.
Me: It was! It turned out to be a nice, unexpected break. Just sitting there, eating something sweet and waiting for the rain to stop. Then it was back to work, and the pace just completely shifted. I had that long meeting about the carbon capture project.
Wife: Ugh, the intense one. How did it go?
Me: It was one of those meetings that just drains your brain, but we really hammered everything out. We finally—finally—landed on a solid plan for what to do next. It’s such a relief.
Wife: That’s amazing! I know how much you wanted to get that sorted out.
Me: Totally. Oh, and I got a call from my dad later.
Wife: Is everything okay?
Me: Yeah, he's okay. His knee was just hurting him badly again. It's so hard being this far away, you know? But he asked me to order him some food, and I was able to get a meal sent right over with Uber Eats. I’m just so grateful for that. Just being able to take care of him in that small way really means a lot.
Wife: Of course it does. I'm glad you could do that for him.
Me: Me too. Anyway, that was my crazy day. Tell me more about yours. It sounds like it was a lot more fun.
Wife: It was just sweet. Seeing how much the kids have grown. It makes me a little nostalgic, but also so excited for what’s next for us.
Me: Me too. Hearing you talk about it just makes me think about our future... and how, this December, we’re going to be starting our new life together in the Netherlands.
Wife: I know. It's all happening so fast.</textarea>
            <div id="parseStatus" class="text-sm text-gray-500 mt-3 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Lines: 0 • Speakers detected: –
            </div>
        </div>

        <!-- Action Button -->
        <button id="generateBtn" class="w-full btn-primary font-bold py-4 px-6 rounded-lg flex items-center justify-center space-x-3 text-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" x2="12" y1="19" y2="22"></line></svg>
            <span>Convert to Audio</span>
        </button>

        <!-- Output Section -->
        <div id="output" class="space-y-6">
            <div id="loader" class="hidden mx-auto loader"></div>
            <div id="progressWrap" class="hidden">
                <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                    <span id="progressLabel">Preparing…</span>
                    <span id="progressPct">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                    <div id="progressBar" class="bg-blue-600 h-3 w-0 transition-[width] duration-300 rounded-full"></div>
                </div>
            </div>
            <div id="error" class="hidden text-red-700 bg-red-50 border border-red-200 p-4 rounded-lg"></div>
            <audio id="audioPlayer" controls class="w-full hidden rounded-lg shadow-sm"></audio>
        </div>
    </div>

    <!-- Mobile sticky action bar -->
    <div class="fixed bottom-0 left-0 right-0 md:hidden bg-white/95 backdrop-blur border-t border-gray-200 p-4">
        <button id="generateBtnMobile" class="w-full btn-primary font-bold py-3 px-6 rounded-lg">Convert to Audio</button>
    </div>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const dialogueText = document.getElementById('dialogue');
        const loader = document.getElementById('loader');
        const errorDiv = document.getElementById('error');
        const audioPlayer = document.getElementById('audioPlayer');
        const voiceSpeaker1 = document.getElementById('voiceSpeaker1');
        const voiceSpeaker2 = document.getElementById('voiceSpeaker2');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const parseStatus = document.getElementById('parseStatus');
        const preview1 = document.getElementById('preview1');
        const preview2 = document.getElementById('preview2');
        const apiKeyBar = document.getElementById('apiKeyBar');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const toggleApiKeyVisibility = document.getElementById('toggleApiKeyVisibility');
        const generateBtnMobile = document.getElementById('generateBtnMobile');
        const progressWrap = document.getElementById('progressWrap');
        const progressBar = document.getElementById('progressBar');
        const progressPct = document.getElementById('progressPct');
        const progressLabel = document.getElementById('progressLabel');

        function setProgress(pct, label) {
            const n = Math.max(0, Math.min(100, Math.round(pct)));
            progressWrap.classList.remove('hidden');
            progressBar.style.width = n + '%';
            progressPct.textContent = n + '%';
            if (label) progressLabel.textContent = label;
        }
        function resetProgress() {
            progressWrap.classList.add('hidden');
            progressBar.style.width = '0%';
            progressPct.textContent = '0%';
            progressLabel.textContent = 'Preparing…';
        }

        // Handle .txt file upload to populate textarea
        uploadBtn?.addEventListener('click', () => fileInput?.click());
        fileInput?.addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            if (file.type && file.type !== 'text/plain' && !file.name.toLowerCase().endsWith('.txt')) {
                errorDiv.textContent = 'Please upload a valid .txt file.';
                errorDiv.classList.remove('hidden');
                return;
            }
            try {
                const text = await file.text();
                dialogueText.value = text;
                errorDiv.classList.add('hidden');
                persistState();
                updateParsing();
            } catch (err) {
                errorDiv.textContent = 'Failed to read the file.';
                errorDiv.classList.remove('hidden');
            } finally {
                fileInput.value = '';
            }
        });

        // Drag & drop support on textarea
        dialogueText.addEventListener('dragover', (e) => {
            e.preventDefault();
            dialogueText.classList.add('ring-2','ring-blue-400');
        });
        dialogueText.addEventListener('dragleave', () => {
            dialogueText.classList.remove('ring-2','ring-blue-400');
        });
        dialogueText.addEventListener('drop', async (e) => {
            e.preventDefault();
            dialogueText.classList.remove('ring-2','ring-blue-400');
            const file = e.dataTransfer?.files?.[0];
            if (file && (file.type === 'text/plain' || file.name.toLowerCase().endsWith('.txt'))) {
                try {
                    const text = await file.text();
                    dialogueText.value = text;
                    persistState();
                    updateParsing();
                } catch {}
            }
        });

        // Persist API key for this session (inline bar, no prompts)
        let apiKey = sessionStorage.getItem('GEMINI_API_KEY') || '';
        function renderApiKeyBar() {
            if (apiKey && apiKey.trim()) {
                apiKeyBar.classList.add('hidden');
                apiKeyInput.value = '';
            } else {
                apiKeyBar.classList.remove('hidden');
            }
        }
        renderApiKeyBar();
        toggleApiKeyVisibility.addEventListener('click', () => {
            apiKeyInput.type = apiKeyInput.type === 'password' ? 'text' : 'password';
            toggleApiKeyVisibility.textContent = apiKeyInput.type === 'password' ? 'Show' : 'Hide';
        });
        saveApiKeyBtn.addEventListener('click', () => {
            const val = apiKeyInput.value.trim();
            if (!val) {
                errorDiv.textContent = 'Please paste a valid API key.';
                errorDiv.classList.remove('hidden');
                return;
            }
            apiKey = val;
            sessionStorage.setItem('GEMINI_API_KEY', apiKey);
            renderApiKeyBar();
            errorDiv.classList.add('hidden');
        });
        function ensureApiKey() {
            if (apiKey && apiKey.trim()) return true;
            renderApiKeyBar();
            apiKeyBar.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }

        // Voice previews
        async function previewVoice(voiceName) {
            if (!ensureApiKey()) return;
            try {
                loader.classList.remove('hidden');
                const payload = {
                    contents: [{ parts: [{ text: 'This is a sample preview.' }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            multiSpeakerVoiceConfig: { speakerVoiceConfigs: [
                                { speaker: "Sample", voiceConfig: { prebuiltVoiceConfig: { voiceName } } }
                            ] }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const result = await generateContentWithBackoff(payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;
                if (audioData && mimeType?.startsWith('audio/')) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)?.[1] || '24000', 10);
                    const pcmBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    audioPlayer.src = URL.createObjectURL(wavBlob);
                    audioPlayer.classList.remove('hidden');
                }
            } catch (e) {
                errorDiv.textContent = `Preview failed: ${e.message}`;
                errorDiv.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        }
        preview1?.addEventListener('click', () => previewVoice(voiceSpeaker1.value));
        preview2?.addEventListener('click', () => previewVoice(voiceSpeaker2.value));

        /**
         * Converts a base64 string to an ArrayBuffer.
         * @param {string} base64 The base64 string to convert.
         * @returns {ArrayBuffer} The resulting ArrayBuffer.
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Converts raw PCM audio data into a WAV file Blob.
         * @param {Int16Array} pcmData The raw PCM data.
         * @param {number} sampleRate The sample rate of the audio.
         * @returns {Blob} A Blob representing the WAV file.
         */
        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const chunkSize = 36 + dataSize;

            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, chunkSize, true);
            writeString(view, 8, 'WAVE');

            // FMT sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size for PCM
            view.setUint16(20, 1, true); // AudioFormat for PCM
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);

            // DATA sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            // Write PCM data
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        /**
         * Helper function to write a string to a DataView.
         * @param {DataView} view The DataView to write to.
         * @param {number} offset The offset to start writing at.
         * @param {string} string The string to write.
         */
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        /**
         * Makes an API call to the Gemini model to generate TTS audio.
         * Implements exponential backoff for retries.
         * @param {object} payload The payload for the API request.
         * @param {number} maxRetries The maximum number of retries.
         * @returns {Promise<object>} The JSON response from the API.
         */
        async function generateContentWithBackoff(payload, maxRetries = 5) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            let delay = 1000; // Initial delay of 1 second

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }

                    if (response.status === 429 || response.status >= 500) {
                        // Throttling or server error, so retry
                        console.warn(`Request failed with status ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Double the delay for the next retry
                    } else {
                        // Other client-side error, don't retry
                        let errorData = {};
                        try { errorData = await response.json(); } catch (_) {}
                        throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) throw error; // Throw error on last retry
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        // Speaker parsing and status
        function extractSpeakers(text) {
            const unique = [];
            const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
            for (const line of lines) {
                const m = line.match(/^([^:]{1,50}):/);
                if (m) {
                    const name = m[1].trim();
                    if (name && !unique.includes(name)) unique.push(name);
                }
            }
            return { linesCount: lines.length, speakers: unique };
        }
        function updateParsing() {
            const { linesCount, speakers } = extractSpeakers(dialogueText.value);
            parseStatus.textContent = `Lines: ${linesCount} • Speakers detected: ${speakers.slice(0, 4).join(', ') || '–'}`;
            return speakers;
        }
        // persist voices and text
        function persistState() {
            localStorage.setItem('es_text', dialogueText.value);
            localStorage.setItem('es_v1', voiceSpeaker1.value);
            localStorage.setItem('es_v2', voiceSpeaker2.value);
        }
        (function restoreState(){
            const t = localStorage.getItem('es_text');
            if (t) dialogueText.value = t;
            const v1 = localStorage.getItem('es_v1');
            if (v1) voiceSpeaker1.value = v1;
            const v2 = localStorage.getItem('es_v2');
            if (v2) voiceSpeaker2.value = v2;
            updateParsing();
        })();
        dialogueText.addEventListener('input', () => { updateParsing(); persistState(); });
        voiceSpeaker1.addEventListener('change', persistState);
        voiceSpeaker2.addEventListener('change', persistState);


        function getSpeakerMapping() {
            const speakers = updateParsing();
            const s1 = speakers[0] || 'Speaker 1';
            const s2 = speakers[1] || 'Speaker 2';
            return { s1, s2 };
        }

        async function doGenerate() {
            const text = dialogueText.value.trim();
            if (!text) {
                errorDiv.textContent = 'Please enter a dialogue script.';
                errorDiv.classList.remove('hidden');
                return;
            }

            // UI updates for loading state
            loader.classList.remove('hidden');
            setProgress(10, 'Validating input…');
            errorDiv.classList.add('hidden');
            audioPlayer.classList.add('hidden');
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');

            try {
                if (!ensureApiKey()) {
                    // Reset UI state if user cancels key entry
                    loader.classList.add('hidden');
                    resetProgress();
                    generateBtn.disabled = false;
                    generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    return;
                }
                // Construct the payload for the multi-speaker TTS API
                setProgress(35, 'Requesting TTS…');
                const { s1, s2 } = getSpeakerMapping();
                const payload = {
                    contents: [{
                        parts: [{ text: `TTS the following conversation. Preserve speaker turns as labelled.\n${text}` }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            multiSpeakerVoiceConfig: {
                                speakerVoiceConfigs: [
                                    { speaker: s1, voiceConfig: { prebuiltVoiceConfig: { voiceName: (voiceSpeaker1?.value || "kore") } } },
                                    { speaker: s2, voiceConfig: { prebuiltVoiceConfig: { voiceName: (voiceSpeaker2?.value || "callirrhoe") } } }
                                ]
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const result = await generateContentWithBackoff(payload);
                setProgress(70, 'Processing audio…');
                
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) {
                        throw new Error("Could not determine sample rate from mime type.");
                    }
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    
                    // The API returns raw signed 16-bit PCM audio data
                    const pcmBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmBuffer);
                    
                    // Convert PCM to a playable WAV format
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    audioPlayer.src = audioUrl;
                    audioPlayer.classList.remove('hidden');
                    setProgress(100, 'Done');
                } else {
                    throw new Error("Invalid response from API. Audio data not found.");
                }

            } catch (error) {
                console.error('Error generating audio:', error);
                errorDiv.textContent = `An error occurred: ${error.message}`;
                errorDiv.classList.remove('hidden');
            } finally {
                // UI updates to end loading state
                loader.classList.add('hidden');
                setTimeout(resetProgress, 600);
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        generateBtn.addEventListener('click', doGenerate);
        generateBtnMobile?.addEventListener('click', doGenerate);
    </script>
</body>
</html>
